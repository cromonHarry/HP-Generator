import streamlit as st
from openai import OpenAI
import os 

# ==========================================
# ğŸ¯ å°‚é–€å®¶ã«ã‚ˆã‚‹åˆæœŸæŒ¨æ‹¶ (Phaseã”ã¨ã®æœ€åˆã®å•ã„ã‹ã‘)
# ==========================================
INITIAL_GREETINGS = {
    "q1": """ã“ã‚“ã«ã¡ã¯ï¼Step 1ã®Q1ï¼ˆä½“é¨“ï¼‰ã«ã¤ã„ã¦ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ã€‚

ã¾ãšã€ã‚ãªãŸãŒã€Œã“ã‚ŒãŒå¥½ãã ï¼ã€ã€Œå¿ƒåœ°ã‚ˆã„ï¼ã€ã¨æ„Ÿã˜ã¦ã„ã‚‹å…·ä½“çš„ãªã‚·ãƒ¼ãƒ³ã‚’æ€ã„æµ®ã‹ã¹ã¦ã¿ã¦ãã ã•ã„ã€‚
ãã‚Œã¯**ã„ã¤ã€ã©ã“ã§ã€ä½•ã‚’ã—ã¦ã„ã‚‹æ™‚**ã§ã™ã‹ï¼Ÿ""",

    "q2": """æ¬¡ã¯Q2ï¼ˆè£½å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã§ã™ã­ã€‚
    
å…ˆã»ã©æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸä½“é¨“ã‚’ã™ã‚‹ãŸã‚ã«ã€**ã€Œã“ã‚ŒãŒãªã„ã¨å§‹ã¾ã‚‰ãªã„ã€ã¨ã„ã†é“å…·ã‚„ã‚µãƒ¼ãƒ“ã‚¹**ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
ï¼ˆä¾‹ï¼šç‰¹å®šã®ã‚¢ãƒ—ãƒªã€æ„›ç”¨ã®é“å…·ã€å ´æ‰€ãªã©ï¼‰""",

    "q3": """Q3ï¼ˆæ„å‘³ãƒ»ç›®çš„ï¼‰ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚

ãªãœã€ãã®è£½å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
å˜ãªã‚‹ä¾¿åˆ©ã•ã ã‘ã§ãªãã€**ãã‚Œã‚’ä½¿ã†ã“ã¨ã§å¾—ã‚‰ã‚Œã‚‹ã€Œå¿ƒã®å……è¶³æ„Ÿã€**ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚""",

    "q4": """æœ€å¾Œã¯Q4ï¼ˆä¾¡å€¤è¦³ï¼‰ã§ã™ã€‚

ãã®ã‚ˆã†ãªä½“é¨“ã‚„è¡Œå‹•ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã‚ãªãŸã¯ã€**ã€Œã©ã‚“ãªè‡ªåˆ†ã€**ã§ã‚ã‚ŠãŸã„ã¨é¡˜ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
ï¼ˆä¾‹ï¼šè‡ªç”±ãªè‡ªåˆ†ã€å‰µé€ çš„ãªè‡ªåˆ†ã€ã¤ãªãŒã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹è‡ªåˆ†...ï¼‰""",

    "normal": "ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"
}

# ==========================================
# ğŸ¯ å°‚é–€å®¶ã«ã‚ˆã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# ==========================================
CONTEXT_PROMPTS = {
    "q1": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯SFãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã€ŒStep 1: Q1ï¼ˆå¥½ããªã“ã¨ã‚’ã—ã¦ã„ã‚‹æƒ…æ™¯ï¼‰ã€ã‚’æ›¸ã“ã†ã¨ã—ã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ã«ä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹è¿·ã£ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
å„ªã—ãè³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®ã€Œ5W1H + æ„Ÿè¦šã€ã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ï¼š
- å…·ä½“çš„ã«ã„ã¤ã€ã©ã“ã§ï¼Ÿï¼ˆæ™‚é–“ã€å ´æ‰€ï¼‰
- å…·ä½“çš„ã«ä½•ã‚’ã—ã¦ã„ã‚‹ã‹ï¼Ÿï¼ˆè¡Œå‹•ï¼‰
- ãã®æ™‚ã€ç›®ã«è¦‹ãˆã‚‹ã‚‚ã®ã€èã“ãˆã‚‹éŸ³ã€è‚Œã§æ„Ÿã˜ã‚‹æ„Ÿè¦šã¯ï¼Ÿï¼ˆäº”æ„Ÿï¼‰
- ãã®æ™‚ã€ã©ã‚“ãªæ„Ÿæƒ…ã‹ï¼Ÿ

ã€ã‚´ãƒ¼ãƒ«ã€‘
å¯¾è©±ã‚’é€šã˜ã¦æƒ…å ±ãŒé›†ã¾ã£ãŸã‚‰ã€æœ€å¾Œã«**ã€Œãã‚Œã§ã¯ã€Q1ã®å›ç­”æ¬„ã«ã¯ã“ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼šã€**ã¨è¨€ã£ã¦ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ãã‚‹**50ã€œ100æ–‡å­—ç¨‹åº¦ã®å…·ä½“çš„ã§æƒ…æ™¯ãŒæµ®ã‹ã¶æ–‡ç« **ã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
""",

    "q2": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q2ï¼ˆä½“é¨“ã‚’æˆç«‹ã•ã›ã‚‹è£½å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã€ã‚’ç‰¹å®šã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒQ1ã§ç­”ãˆãŸä½“é¨“ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ã€Œçµ¶å¯¾ã«æ¬ ã‹ã›ãªã„é“å…·ã€ã‚¢ãƒ—ãƒªã€æ–½è¨­ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒä½•ã‹ã‚’ç‰¹å®šã™ã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q2ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œå…·ä½“çš„ãªè£½å“åï¼ˆæ¶ç©ºã§ã‚‚å¯ï¼‰ã€ã‚„ã€Œã‚µãƒ¼ãƒ“ã‚¹åã€**ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šã€Œãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã€ã€ã€Œå®Œå…¨æ²¡å…¥å‹VRãƒãƒ£ãƒƒãƒˆã€ã€ã€Œé™å¯‚ã‚’æä¾›ã™ã‚‹ä¼šå“¡åˆ¶ã‚«ãƒ•ã‚§ã€ãªã©ï¼‰
""",

    "q3": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q3ï¼ˆãªãœãã®è£½å“ã‚’ä½¿ã†ã®ã‹ï¼Ÿï¼‰ã€ã¨ã„ã†æ·±å±¤å¿ƒç†ã‚„ç›®çš„ã‚’è¨€èªåŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ã€Œä¾¿åˆ©ã ã‹ã‚‰ã€ã¨ã„ã†è¡¨é¢çš„ãªç†ç”±ã®å…ˆã«ã‚ã‚‹ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…çš„ãªå……è¶³æ„Ÿã‚„ã€äººç”Ÿã«ãŠã‘ã‚‹æ„å‘³**ã‚’æ·±æ˜ã‚Šã—ã¦ãã ã•ã„ã€‚
- ãªãœãã‚ŒãŒé‡è¦ãªã®ã‹ï¼Ÿ
- ãã‚ŒãŒãªã„ã¨ã€ã©ã†ãªã£ã¦ã—ã¾ã†ã®ã‹ï¼Ÿ

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q3ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œã€œã™ã‚‹ãŸã‚ã«ã€ã€Œã€œã¨ã„ã†æ„Ÿè¦šã‚’å¾—ã‚‹ãŸã‚ã«ã€**ã¨ã„ã†å½¢å¼ã®æ–‡ç« ã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
""",

    "q4": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q4ï¼ˆãã®ã‚ˆã†ãªä½“é¨“ã‚’ã™ã‚‹è‡ªåˆ†ã¯ã€ã©ã‚“ãªè‡ªåˆ†ã§ã‚ã‚ŠãŸã„ã‹ï¼‰ã€ã¨ã„ã†ä¾¡å€¤è¦³ï¼ˆValuesï¼‰ã‚’è¨€èªåŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã®æ ¹åº•ã«ã‚ã‚‹**ã€Œã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚„ã€Œå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³ã€**ã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ã€‚
- ä»–è€…ã‹ã‚‰ã©ã†è¦‹ã‚‰ã‚ŒãŸã„ã‹ï¼Ÿ
- è‡ªåˆ†è‡ªèº«ã‚’ã©ã†è©•ä¾¡ã—ãŸã„ã‹ï¼Ÿ
- ï¼ˆä¾‹ï¼šè‡ªç”±ãªã€å‰µé€ çš„ãªã€åŠ¹ç‡çš„ãªã€ã¤ãªãŒã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹...ï¼‰

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q4ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œã€œãªè‡ªåˆ†ã€ã€Œã€œã‚’å¤§åˆ‡ã«ã™ã‚‹è‡ªåˆ†ã€**ã¨ã„ã†å½¢å¼ã®çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
"""
}

DEFAULT_SYSTEM_PROMPT = "ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œã‚¢ãƒ¼ã‚­ã‚ªãƒ­ã‚¸ã‚«ãƒ«ãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆHPï¼‰ã€ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ç›¸è«‡ã—ã¾ã™ã€‚ç°¡æ½”ãªè¨€è‘‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚ã™ã¹ã¦ã®è³ªå•ã«æ—¥æœ¬èªã§ä¸å¯§ã«ç­”ãˆã¦ãã ã•ã„ã€‚"

# --- API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– ---
def get_openai_client():
    try:
        api_key = st.secrets["openai"]["api_key"]
    except KeyError:
        api_key = os.environ.get("OPENAI_API_KEY") 
    if not api_key:
        st.error("ã‚¨ãƒ©ãƒ¼: OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()
    try:
        return OpenAI(api_key=api_key)
    except Exception as e:
        st.error(f"OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        st.stop()


def get_ai_response(chat_history: list, mode: str, user_context: dict) -> str:
    """
    ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆq1-q4, normalï¼‰ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¢å­˜å›ç­”(user_context)ã‚’è€ƒæ…®ã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹
    """
    client = get_openai_client()
    
    # 1. åŸºæœ¬çš„ãªæŒ‡ç¤º
    specific_instruction = CONTEXT_PROMPTS.get(mode, DEFAULT_SYSTEM_PROMPT)
    
    # 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å…¥åŠ›ã—ãŸæƒ…å ±ã®æ³¨å…¥ï¼ˆæ–‡è„ˆå…±æœ‰ï¼‰
    context_str = ""
    if user_context:
        context_str = "\nã€ç¾åœ¨ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æƒ…å ±ï¼ˆå‚è€ƒï¼‰ã€‘\n"
        if user_context.get("q1_ux"): context_str += f"- Q1(ä½“é¨“): {user_context['q1_ux']}\n"
        if user_context.get("q2_product"): context_str += f"- Q2(è£½å“): {user_context['q2_product']}\n"
        if user_context.get("q3_meaning"): context_str += f"- Q3(æ„å‘³): {user_context['q3_meaning']}\n"
        if user_context.get("q4_value"): context_str += f"- Q4(ä¾¡å€¤è¦³): {user_context['q4_value']}\n"

    system_prompt = f"""
{specific_instruction}

{context_str}

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
1. **æ—¥æœ¬èª**ã§ã€è¦ªã—ã¿ã‚„ã™ãä¸å¯§ï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã«è©±ã—ã¦ãã ã•ã„ã€‚
2. ä¸€åº¦ã«å¤šãã®è³ªå•ã‚’ã›ãšã€1ã¤ãšã¤èã„ã¦ãã ã•ã„ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç­”ãˆã«è©°ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ã€ã€Œä¾‹ãˆã°ã€œã®ã‚ˆã†ãªã“ã¨ã§ã™ã‹ï¼Ÿã€ã¨é¸æŠè‚¢ã‚’æç¤ºã—ã¦èª˜å°ã—ã¦ãã ã•ã„ã€‚
"""
    
    messages_for_api = [{"role": "system", "content": system_prompt}]
    messages_for_api.extend(chat_history)
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages_for_api, 
            temperature=0.7,
            max_tokens=800
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"AIå¿œç­”ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"


def render_chat_ui(container, current_phase: str, user_inputs: dict):
    """
    UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ¡ã‚¤ãƒ³é–¢æ•°
    current_phase: 'q1', 'q2', 'q3', 'q4', or 'normal'
    user_inputs: ãƒ¡ã‚¤ãƒ³ç”»é¢ã§å…¥åŠ›ã•ã‚ŒãŸå›ç­”ã®è¾æ›¸
    """
    with container:

        st.header("ğŸ¤– AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")

        # ===================================================
        # 1. ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ¤œçŸ¥ã¨è‡ªå‹•ãƒªã‚»ãƒƒãƒˆï¼†åˆæœŸæŒ¨æ‹¶
        # ===================================================
        if "chat_phase" not in st.session_state:
            st.session_state.chat_phase = "init"
            st.session_state.chat_history = []

        # ãƒ•ã‚§ãƒ¼ã‚ºãŒå¤‰ã‚ã£ãŸã‚‰å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€åˆæœŸæŒ¨æ‹¶ã‚’è¿½åŠ 
        if st.session_state.chat_phase != current_phase:
            st.session_state.chat_phase = current_phase
            st.session_state.chat_history = []
            
            # åˆæœŸæŒ¨æ‹¶ã‚’å–å¾—ã—ã¦è¿½åŠ 
            greeting_msg = INITIAL_GREETINGS.get(current_phase, INITIAL_GREETINGS["normal"])
            st.session_state.chat_history.append({"role": "assistant", "content": greeting_msg})
            
        # ç¾åœ¨ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’æ§ãˆã‚ã«è¡¨ç¤º
        phase_labels = {
            "q1": "Q1ã«ã¤ã„ã¦ç›¸è«‡ä¸­...",
            "q2": "Q2ã«ã¤ã„ã¦ç›¸è«‡ä¸­...",
            "q3": "Q3ã«ã¤ã„ã¦ç›¸è«‡ä¸­...",
            "q4": "Q4ã«ã¤ã„ã¦ç›¸è«‡ä¸­...",
            "normal": "ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒƒãƒˆ"
        }
        st.caption(f"Topic: {phase_labels.get(current_phase, 'General')}")

        
        # ===================================================
        # 2. ãƒãƒ£ãƒƒãƒˆå±¥æ­´ (3ç•ªç›®)
        # ===================================================
        # ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’å›ºå®šã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«
        chat_container = st.container(height=400)
        
        with chat_container:
            for msg in st.session_state.chat_history:
                color = "#DCF8C6" if msg["role"] == "user" else "#F1F0F0"
                float_dir = "right" if msg["role"] == "user" else "left"
                
                st.markdown(f"""
                    <div style='background-color:{color}; padding:10px; border-radius:10px; margin:5px 0; max-width:85%; float:{float_dir}; clear:both; color:black;'>
                        {msg['content']}
                    </div>
                """, unsafe_allow_html=True)
            
            st.markdown("<div style='clear: both;'></div>", unsafe_allow_html=True)


        # ===================================================
        # 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
        # ===================================================
        with st.form(key="chat_form", clear_on_submit=True):
            user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›", placeholder="ä¾‹ï¼šä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„...", key="chat_input_field")
            
            col_btn1, col_btn2 = st.columns([1, 4])
            with col_btn1:
                submit_btn = st.form_submit_button("é€ä¿¡")
            
            if submit_btn and user_input.strip():
                # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€
                st.session_state.chat_history.append({"role": "user", "content": user_input})
                
                with st.spinner("AIãŒè€ƒãˆã¦ã„ã¾ã™â€¦"):
                    # 2. AIå¿œç­”
                    ai_reply = get_ai_response(st.session_state.chat_history, current_phase, user_inputs)
                        
                # 3. AIå¿œç­”è¿½åŠ 
                st.session_state.chat_history.append({"role": "assistant", "content": ai_reply})
                
                st.rerun() 

        # ===================================================
        # 4. æ¸…ç©ºãƒœã‚¿ãƒ³
        # ===================================================
        if st.button("ğŸ”„ ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ", key="btn_clear_bottom", help="ä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™"):
            st.session_state.chat_history = []
            # ãƒªã‚»ãƒƒãƒˆæ™‚ã‚‚åˆæœŸæŒ¨æ‹¶ã¯å…¥ã‚Œã‚‹
            greeting_msg = INITIAL_GREETINGS.get(current_phase, INITIAL_GREETINGS["normal"])
            st.session_state.chat_history.append({"role": "assistant", "content": greeting_msg})
            st.rerun()