import streamlit as st
from openai import OpenAI
import os 

# ==========================================
# ğŸ¯ ä¸“é—¨é’ˆå¯¹ Q1-Q4 çš„å¼•å¯¼ Prompt å®šä¹‰
# ==========================================
CONTEXT_PROMPTS = {
    "q1": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯SFãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã€ŒStep 1: Q1ï¼ˆå¥½ããªã“ã¨ã‚’ã—ã¦ã„ã‚‹æƒ…æ™¯ï¼‰ã€ã‚’æ›¸ã“ã†ã¨ã—ã¦ã„ã¾ã™ãŒã€å…·ä½“çš„ã«ä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹è¿·ã£ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
å„ªã—ãè³ªå•ã‚’æŠ•ã’ã‹ã‘ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®ã€Œ5W1H + æ„Ÿè¦šã€ã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ï¼š
- å…·ä½“çš„ã«ã„ã¤ã€ã©ã“ã§ï¼Ÿï¼ˆæ™‚é–“ã€å ´æ‰€ï¼‰
- å…·ä½“çš„ã«ä½•ã‚’ã—ã¦ã„ã‚‹ã‹ï¼Ÿï¼ˆè¡Œå‹•ï¼‰
- ãã®æ™‚ã€ç›®ã«è¦‹ãˆã‚‹ã‚‚ã®ã€èã“ãˆã‚‹éŸ³ã€è‚Œã§æ„Ÿã˜ã‚‹æ„Ÿè¦šã¯ï¼Ÿï¼ˆäº”æ„Ÿï¼‰
- ãã®æ™‚ã€ã©ã‚“ãªæ„Ÿæƒ…ã‹ï¼Ÿ

ã€ã‚´ãƒ¼ãƒ«ã€‘
å¯¾è©±ã‚’é€šã˜ã¦æƒ…å ±ãŒé›†ã¾ã£ãŸã‚‰ã€æœ€å¾Œã«**ã€Œãã‚Œã§ã¯ã€Q1ã®å›ç­”æ¬„ã«ã¯ã“ã®ã‚ˆã†ã«æ›¸ã„ã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼šã€**ã¨è¨€ã£ã¦ã€
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã§ãã‚‹**50ã€œ100æ–‡å­—ç¨‹åº¦ã®å…·ä½“çš„ã§æƒ…æ™¯ãŒæµ®ã‹ã¶æ–‡ç« **ã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
""",

    "q2": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q2ï¼ˆä½“é¨“ã‚’æˆç«‹ã•ã›ã‚‹è£½å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã€ã‚’ç‰¹å®šã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒQ1ã§ç­”ãˆãŸä½“é¨“ï¼ˆã‚‚ã—åˆ†ã‹ã‚‰ãªã‘ã‚Œã°æœ€åˆã«èã„ã¦ãã ã•ã„ï¼‰ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€
ã€Œçµ¶å¯¾ã«æ¬ ã‹ã›ãªã„é“å…·ã€ã‚¢ãƒ—ãƒªã€æ–½è¨­ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ãŒä½•ã‹ã‚’ç‰¹å®šã™ã‚‹æ‰‹åŠ©ã‘ã‚’ã—ã¦ãã ã•ã„ã€‚

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q2ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œå…·ä½“çš„ãªè£½å“åï¼ˆæ¶ç©ºã§ã‚‚å¯ï¼‰ã€ã‚„ã€Œã‚µãƒ¼ãƒ“ã‚¹åã€**ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šã€Œãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã€ã€ã€Œå®Œå…¨æ²¡å…¥å‹VRãƒãƒ£ãƒƒãƒˆã€ã€ã€Œé™å¯‚ã‚’æä¾›ã™ã‚‹ä¼šå“¡åˆ¶ã‚«ãƒ•ã‚§ã€ãªã©ï¼‰
""",

    "q3": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q3ï¼ˆãªãœãã®è£½å“ã‚’ä½¿ã†ã®ã‹ï¼Ÿï¼‰ã€ã¨ã„ã†æ·±å±¤å¿ƒç†ã‚„ç›®çš„ã‚’è¨€èªåŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ã€Œä¾¿åˆ©ã ã‹ã‚‰ã€ã¨ã„ã†è¡¨é¢çš„ãªç†ç”±ã®å…ˆã«ã‚ã‚‹ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„Ÿæƒ…çš„ãªå……è¶³æ„Ÿã‚„ã€äººç”Ÿã«ãŠã‘ã‚‹æ„å‘³**ã‚’æ·±æ˜ã‚Šã—ã¦ãã ã•ã„ã€‚
- ãªãœãã‚ŒãŒé‡è¦ãªã®ã‹ï¼Ÿ
- ãã‚ŒãŒãªã„ã¨ã€ã©ã†ãªã£ã¦ã—ã¾ã†ã®ã‹ï¼Ÿ

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q3ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œã€œã™ã‚‹ãŸã‚ã«ã€ã€Œã€œã¨ã„ã†æ„Ÿè¦šã‚’å¾—ã‚‹ãŸã‚ã«ã€**ã¨ã„ã†å½¢å¼ã®æ–‡ç« ã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
""",

    "q4": """
ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ŒStep 1: Q4ï¼ˆãã®ã‚ˆã†ãªä½“é¨“ã‚’ã™ã‚‹è‡ªåˆ†ã¯ã€ã©ã‚“ãªè‡ªåˆ†ã§ã‚ã‚ŠãŸã„ã‹ï¼‰ã€ã¨ã„ã†ä¾¡å€¤è¦³ï¼ˆValuesï¼‰ã‚’è¨€èªåŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã®æ ¹åº•ã«ã‚ã‚‹**ã€Œã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚„ã€Œå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³ã€**ã‚’å¼•ãå‡ºã—ã¦ãã ã•ã„ã€‚
- ä»–è€…ã‹ã‚‰ã©ã†è¦‹ã‚‰ã‚ŒãŸã„ã‹ï¼Ÿ
- è‡ªåˆ†è‡ªèº«ã‚’ã©ã†è©•ä¾¡ã—ãŸã„ã‹ï¼Ÿ
- ï¼ˆä¾‹ï¼šè‡ªç”±ãªã€å‰µé€ çš„ãªã€åŠ¹ç‡çš„ãªã€ã¤ãªãŒã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹...ï¼‰

ã€ã‚´ãƒ¼ãƒ«ã€‘
æœ€çµ‚çš„ã«ã€Q4ã®å›ç­”æ¬„ã«è¨˜å…¥ã™ã‚‹ãŸã‚ã®**ã€Œã€œãªè‡ªåˆ†ã€ã€Œã€œã‚’å¤§åˆ‡ã«ã™ã‚‹è‡ªåˆ†ã€**ã¨ã„ã†å½¢å¼ã®çŸ­ã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ä½œæˆã—ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚
"""
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆStep 2ä»¥é™ãªã©ï¼‰
DEFAULT_SYSTEM_PROMPT = "ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œã‚¢ãƒ¼ã‚­ã‚ªãƒ­ã‚¸ã‚«ãƒ«ãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆHPï¼‰ã€ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦ç›¸è«‡ã—ã¾ã™ã€‚ç°¡æ½”ãªè¨€è‘‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚"

# --- API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– ---
def get_openai_client():
    try:
        api_key = st.secrets["openai"]["api_key"]
    except KeyError:
        api_key = os.environ.get("OPENAI_API_KEY") 
    if not api_key:
        st.error("ã‚¨ãƒ©ãƒ¼: OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        st.stop()
    try:
        return OpenAI(api_key=api_key)
    except Exception as e:
        st.error(f"OpenAIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        st.stop()


def get_ai_response(chat_history: list, mode: str) -> str:
    """
    ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆq1-q4, normalï¼‰ã«å¿œã˜ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹
    """
    client = get_openai_client()
    
    # ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
    specific_instruction = CONTEXT_PROMPTS.get(mode, DEFAULT_SYSTEM_PROMPT)
    
    system_prompt = f"""
{specific_instruction}

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
1. **æ—¥æœ¬èª**ã§ã€è¦ªã—ã¿ã‚„ã™ãä¸å¯§ï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰ã«è©±ã—ã¦ãã ã•ã„ã€‚
2. ä¸€åº¦ã«å¤šãã®è³ªå•ã‚’ã›ãšã€1ã¤ãšã¤èã„ã¦ãã ã•ã„ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç­”ãˆã«è©°ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ã€ã€Œä¾‹ãˆã°ã€œã®ã‚ˆã†ãªã“ã¨ã§ã™ã‹ï¼Ÿã€ã¨é¸æŠè‚¢ã‚’æç¤ºã—ã¦èª˜å°ã—ã¦ãã ã•ã„ã€‚
"""
    
    messages_for_api = [{"role": "system", "content": system_prompt}]
    messages_for_api.extend(chat_history)
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages_for_api, 
            temperature=0.7,
            max_tokens=800
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"AIå¿œç­”ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"


def render_chat_ui(container, current_phase: str):
    """
    UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ¡ã‚¤ãƒ³é–¢æ•°
    current_phase: 'q1', 'q2', 'q3', 'q4', or 'normal'
    """
    with container:
        st.header("ğŸ¤– åŸ·ç­†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")

        # ===================================================
        # 1. ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´æ¤œçŸ¥ã¨ãƒªã‚»ãƒƒãƒˆ
        # ===================================================
        if "chat_phase" not in st.session_state:
            st.session_state.chat_phase = "init"
            st.session_state.chat_history = []

        # å‰å›ã®ãƒ•ã‚§ãƒ¼ã‚ºã¨ç•°ãªã‚‹å ´åˆã€å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
        if st.session_state.chat_phase != current_phase:
            st.session_state.chat_history = []
            st.session_state.chat_phase = current_phase
            # ãƒªã‚»ãƒƒãƒˆç›´å¾Œã¯rerunã—ã¦ç”»é¢ã‚’ã‚¯ãƒªã‚¢ã—ãŸçŠ¶æ…‹ã§è¡¨ç¤ºã—ãŸã„ãŒã€
            # ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ããŸã‚ã€ã“ã“ã§ã¯å±¥æ­´ã‚¯ãƒªã‚¢ã®ã¿è¡Œã„ã€UIæç”»ã«é€²ã‚€

        # ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®è¡¨ç¤ºã‚¿ã‚¤ãƒˆãƒ«
        phase_titles = {
            "q1": "Q1: ä½“é¨“ (Experience) ã®ä½œæˆä¸­",
            "q2": "Q2: è£½å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ (Product) ã®ç‰¹å®šä¸­",
            "q3": "Q3: ç›®çš„ãƒ»æ„å‘³ (Meaning) ã®æ·±æ˜ã‚Šä¸­",
            "q4": "Q4: ç†æƒ³ã®è‡ªåˆ† (Values) ã®è¨€èªåŒ–ä¸­",
            "normal": "ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰"
        }
        title_text = phase_titles.get(current_phase, "ãƒ•ãƒªãƒ¼ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰")
        
        st.info(f"ğŸ’¡ **{title_text}**")
        st.markdown("<small>â€»è³ªå•ãŒé€²ã‚€ã¨ã€è‡ªå‹•çš„ã«ä¼šè©±ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œæ¬¡ã®è©±é¡Œã«ç§»ã‚Šã¾ã™ã€‚</small>", unsafe_allow_html=True)
        
        # ===================================================
        # 2. ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤º
        # ===================================================
        
        # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠï¼ˆé«˜ã•å›ºå®šï¼‰
        chat_container = st.container(height=400)
        
        with chat_container:
            # åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå±¥æ­´ãŒç©ºã®å ´åˆï¼‰
            if not st.session_state.chat_history:
                welcome_msg = ""
                if current_phase in CONTEXT_PROMPTS:
                    welcome_msg = f"""
                    ã“ã‚“ã«ã¡ã¯ï¼<br>
                    <b>{title_text}</b> ã§ã™ã­ã€‚<br>
                    ä½•ã‚’æ›¸ã‘ã°ã„ã„ã‹è¿·ã£ãŸã‚‰ã€ç§ãŒã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã—ã¦ç­”ãˆã‚’ä¸€ç·’ã«ä½œã‚Šã¾ã™ã€‚<br>
                    ã€Œã‚ˆã‚ã—ãã€ã‚„ã€Œæ‰‹ä¼ã£ã¦ã€ã¨è©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼
                    """
                else:
                    welcome_msg = "ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"

                st.markdown(f"""
                <div style='background-color: #f0f2f6; padding: 10px; border-radius: 10px; margin-bottom: 10px; color: #333;'>
                    {welcome_msg}
                </div>
                """, unsafe_allow_html=True)

            for msg in st.session_state.chat_history:
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨AIã§è‰²ã¨é…ç½®ã‚’å¤‰ãˆã‚‹
                if msg["role"] == "user":
                    bg_color = "#e8f0fe" # è–„ã„é’
                    align = "right"
                    text_color = "#333"
                else:
                    bg_color = "#f0f2f6" # è–„ã„ã‚°ãƒ¬ãƒ¼
                    align = "left"
                    text_color = "#333"
                
                st.markdown(f"""
                    <div style='text-align: {align}; margin-bottom: 5px;'>
                        <div style='display: inline-block; background-color: {bg_color}; padding: 8px 12px; border-radius: 15px; text-align: left; max-width: 85%; color: {text_color}; box-shadow: 0 1px 2px rgba(0,0,0,0.1);'>
                            {msg['content']}
                        </div>
                    </div>
                """, unsafe_allow_html=True)

        # ===================================================
        # 3. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
        # ===================================================
        with st.form(key="chat_form", clear_on_submit=True):
            user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›:", placeholder="ä¾‹ï¼šã†ã¾ãæ›¸ã‘ãªã„ã®ã§æ‰‹ä¼ã£ã¦...", key="user_input_field")
            
            col1, col2 = st.columns([1, 4])
            with col1:
                submit_btn = st.form_submit_button("é€ä¿¡", type="primary")
            
            if submit_btn and user_input:
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å±¥æ­´ã«è¿½åŠ 
                st.session_state.chat_history.append({"role": "user", "content": user_input})
                
                # AIã®å¿œç­”ã‚’å–å¾—ï¼ˆã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºï¼‰
                with st.spinner("AIãŒè€ƒãˆã¦ã„ã¾ã™..."):
                    ai_reply = get_ai_response(st.session_state.chat_history, current_phase)
                
                # AIã®å¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ 
                st.session_state.chat_history.append({"role": "assistant", "content": ai_reply})
                
                st.rerun()

        # ===================================================
        # 4. æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        # ===================================================
        if st.button("ğŸ—‘ï¸ ã“ã®è©±é¡Œã‚’ãƒªã‚»ãƒƒãƒˆ", key="clear_chat_manual"):
            st.session_state.chat_history = []
            st.rerun()